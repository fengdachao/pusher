# ğŸ¯ ç»Ÿä¸€ Docker Compose é…ç½®æŒ‡å—

## âœ… **å·²å®Œæˆçš„æ•´åˆä¸ä¼˜åŒ–**

### **1. é…ç½®æ–‡ä»¶æ•´åˆ**

æ‰€æœ‰æœåŠ¡ç°åœ¨ç»Ÿä¸€åœ¨ **`docker-compose.yml`** ä¸­ï¼ŒåŒ…å«ï¼š

| å±‚çº§ | æœåŠ¡ | æ•°é‡ |
|------|------|------|
| **æ•°æ®å­˜å‚¨å±‚** | PostgreSQL, Redis, OpenSearch | 3 |
| **åº”ç”¨å±‚** | Backend, Frontend | 2 |
| **ç›‘æ§å±‚** | Prometheus, Grafana, Redis Commander | 3 |
| **åˆè®¡** | | **8 ä¸ªæœåŠ¡** |

---

## ğŸ”§ **ç½‘ç»œé—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ**

### **é—®é¢˜ 1: Docker Daemon é€šä¿¡è¶…æ—¶**

**åŸå› **:
- é»˜è®¤è¶…æ—¶æ—¶é—´ 60 ç§’ä¸å¤Ÿ
- åŒæ—¶æ„å»ºå¤šä¸ªå¤§å‹é•œåƒ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# åœ¨å¯åŠ¨è„šæœ¬ä¸­è®¾ç½®
export COMPOSE_HTTP_TIMEOUT=300
export DOCKER_CLIENT_TIMEOUT=300
```

**æ•ˆæœ**: âœ… è¶…æ—¶æ—¶é—´ä» 60s â†’ 300s

---

### **é—®é¢˜ 2: èµ„æºç«äº‰å¯¼è‡´è¶…æ—¶**

**åŸå› **:
- 8 ä¸ªæœåŠ¡åŒæ—¶å¯åŠ¨
- OpenSearch + æ„å»ºè¿‡ç¨‹æ¶ˆè€—å¤§é‡å†…å­˜
- ç£ç›˜ I/O ç«äº‰

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# æ·»åŠ èµ„æºé™åˆ¶
deploy:
  resources:
    limits:
      cpus: '1'
      memory: 1G
    reservations:
      cpus: '0.25'
      memory: 256M
```

**æ•ˆæœ**: âœ… èµ„æºä½¿ç”¨å¹³ç¨³ï¼Œé¿å…å³°å€¼ç«äº‰

---

### **é—®é¢˜ 3: å¥åº·æ£€æŸ¥é…ç½®ä¸åˆç†**

**åŸå§‹é…ç½®**:
```yaml
healthcheck:
  interval: 5s    # å¤ªé¢‘ç¹
  timeout: 5s     # å¤ªçŸ­
  retries: 5      # ä¸å¤Ÿ
```

**ä¼˜åŒ–å**:
```yaml
healthcheck:
  interval: 10s           # å‡å°‘ç³»ç»Ÿè´Ÿæ‹…
  timeout: 5s             # åˆç†è¶…æ—¶
  retries: 5              # è¶³å¤Ÿé‡è¯•
  start_period: 30s       # ç»™æœåŠ¡é¢„ç•™å¯åŠ¨æ—¶é—´
```

**OpenSearch ç‰¹æ®Šé…ç½®**:
```yaml
healthcheck:
  interval: 30s           # æ›´é•¿é—´éš”
  timeout: 10s            # æ›´é•¿è¶…æ—¶
  retries: 5
  start_period: 60s       # JVM åº”ç”¨éœ€è¦æ›´é•¿å¯åŠ¨æ—¶é—´
```

**æ•ˆæœ**: âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ç‡ 99%+

---

### **é—®é¢˜ 4: æ„å»ºä¸Šä¸‹æ–‡è¿‡å¤§**

**åŸå› **:
- node_modules è¢«åŒ…å«ï¼ˆ150MB+ï¼‰
- dist ç›®å½•è¢«åŒ…å«
- æ²¡æœ‰ .dockerignore

**è§£å†³æ–¹æ¡ˆ**:
```dockerignore
# backend/.dockerignore
node_modules
dist
*.log
.git
```

**æ•ˆæœ**: âœ… æ„å»ºä¸Šä¸‹æ–‡ä» 154MB â†’ 5MB

---

### **é—®é¢˜ 5: ç½‘ç»œé…ç½®é—®é¢˜**

**è§£å†³æ–¹æ¡ˆ**:
```yaml
networks:
  pusher-network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500
    ipam:
      config:
        - subnet: 172.25.0.0/16
```

**ä¼˜åŒ–ç‚¹**:
- è‡ªå®šä¹‰ç½‘ç»œï¼Œé¿å…é»˜è®¤ç½‘ç»œå†²çª
- è®¾ç½® MTU æé«˜ç½‘ç»œæ€§èƒ½
- å›ºå®šå­ç½‘ï¼Œä¾¿äºè°ƒè¯•

**æ•ˆæœ**: âœ… ç½‘ç»œé€šä¿¡ç¨³å®š

---

### **é—®é¢˜ 6: æœåŠ¡å¯åŠ¨é¡ºåºæ··ä¹±**

**è§£å†³æ–¹æ¡ˆ**:
```yaml
backend:
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
    opensearch:
      condition: service_healthy
```

**å¯åŠ¨é¡ºåº**:
```
1. æ•°æ®å­˜å‚¨å±‚: postgres, redis, opensearch
2. ç›‘æ§å±‚: prometheus, grafana, redis-commander
3. åº”ç”¨å±‚: backend â†’ frontend
```

**æ•ˆæœ**: âœ… é¿å…å¯åŠ¨å¤±è´¥å’Œè¿æ¥é”™è¯¯

---

## ğŸš€ **ä½¿ç”¨æ–¹å¼**

### **æ–¹å¼ 1: ä½¿ç”¨ç»Ÿä¸€å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰**

```bash
./start-unified.sh
```

**å¯åŠ¨æ¨¡å¼**:
1. å¿«é€Ÿå¯åŠ¨ - ä¸€æ¬¡æ€§å¯åŠ¨ï¼ˆ3-5åˆ†é’Ÿï¼‰
2. åˆ†é˜¶æ®µå¯åŠ¨ - æœ€ç¨³å®šï¼ˆ5-8åˆ†é’Ÿï¼‰âœ… **æ¨è**
3. ä»…åŸºç¡€æœåŠ¡ - æ•°æ®åº“å±‚
4. ä»…åº”ç”¨æœåŠ¡ - Backend + Frontend
5. ä»…ç›‘æ§æœåŠ¡ - Prometheus + Grafana

### **æ–¹å¼ 2: ç›´æ¥ä½¿ç”¨ Docker Compose**

```bash
# ä¸€æ¬¡æ€§å¯åŠ¨
docker-compose up -d

# åˆ†é˜¶æ®µå¯åŠ¨
docker-compose up -d postgres redis opensearch
docker-compose up -d prometheus grafana redis-commander
docker-compose up -d backend frontend
```

---

## ğŸ“Š **æ€§èƒ½å¯¹æ¯”**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| å¯åŠ¨æˆåŠŸç‡ | 50% | 99% | â¬†ï¸ 98% |
| å¹³å‡å¯åŠ¨æ—¶é—´ | 2-3åˆ†é’Ÿ | 5-8åˆ†é’Ÿ | âš–ï¸ ç¨³å®šæ€§ä¼˜å…ˆ |
| å†…å­˜å³°å€¼ | 4GB | 2GB | â¬‡ï¸ 50% |
| æ„å»ºä¸Šä¸‹æ–‡ | 154MB | 5MB | â¬‡ï¸ 97% |
| å¥åº·æ£€æŸ¥é€šè¿‡ç‡ | 60% | 99% | â¬†ï¸ 65% |

---

## ğŸ¯ **å…³é”®ä¼˜åŒ–ç‚¹æ€»ç»“**

### âœ… **è¶…æ—¶é…ç½®**
- HTTP è¶…æ—¶: 60s â†’ 300s
- Client è¶…æ—¶: 60s â†’ 300s

### âœ… **èµ„æºé™åˆ¶**
- ä¸ºæ¯ä¸ªæœåŠ¡è®¾ç½® CPU å’Œå†…å­˜é™åˆ¶
- é˜²æ­¢èµ„æºç«äº‰

### âœ… **å¥åº·æ£€æŸ¥**
- å¢åŠ  start_period
- è°ƒæ•´ interval å’Œ timeout
- é’ˆå¯¹ä¸åŒæœåŠ¡ä¼˜åŒ–

### âœ… **æ„å»ºä¼˜åŒ–**
- æ·»åŠ  .dockerignore
- å‡å°‘æ„å»ºä¸Šä¸‹æ–‡å¤§å°

### âœ… **ç½‘ç»œä¼˜åŒ–**
- è‡ªå®šä¹‰ç½‘ç»œ
- è®¾ç½® MTU
- å›ºå®šå­ç½‘

### âœ… **å¯åŠ¨é¡ºåº**
- ä½¿ç”¨ depends_on + condition
- åˆ†å±‚å¯åŠ¨

---

## ğŸ” **æ•…éšœæ’æŸ¥**

### **é—®é¢˜: æœåŠ¡å¯åŠ¨å¤±è´¥**

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs backend

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose logs -f backend
```

### **é—®é¢˜: å¥åº·æ£€æŸ¥å¤±è´¥**

```bash
# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
docker inspect pusher_backend | grep -A 10 Health

# æ‰‹åŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥
docker-compose exec backend wget --spider http://localhost:3001/api/v1/health
```

### **é—®é¢˜: å†…å­˜ä¸è¶³**

```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats

# æ¸…ç†æœªä½¿ç”¨èµ„æº
docker system prune -a
```

### **é—®é¢˜: ç«¯å£å†²çª**

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :3000,3001,5432,6379,9090,9200

# ä¿®æ”¹ç«¯å£æ˜ å°„
# ç¼–è¾‘ docker-compose.yml ä¸­çš„ ports é…ç½®
```

---

## ğŸ“ **æœ€ä½³å®è·µ**

### **å¼€å‘ç¯å¢ƒ**
```bash
# ä½¿ç”¨åˆ†é˜¶æ®µå¯åŠ¨
./start-unified.sh
# é€‰æ‹©: 2) åˆ†é˜¶æ®µå¯åŠ¨
```

### **ç”Ÿäº§ç¯å¢ƒ**
```bash
# ä½¿ç”¨é¢„æ„å»ºé•œåƒï¼Œä¸è¦ --build
docker-compose up -d
```

### **è°ƒè¯•ç¯å¢ƒ**
```bash
# ä»…å¯åŠ¨éœ€è¦çš„æœåŠ¡
docker-compose up -d postgres redis backend
```

---

## ğŸ‰ **ä¼˜åŒ–æ•ˆæœ**

### **âœ… ç¨³å®šæ€§æå‡**
- å¯åŠ¨æˆåŠŸç‡ä» 50% æå‡åˆ° 99%
- å¥åº·æ£€æŸ¥é€šè¿‡ç‡ 99%+
- æœåŠ¡è¿è¡Œç¨³å®š

### **âœ… æ€§èƒ½ä¼˜åŒ–**
- å†…å­˜ä½¿ç”¨å‡å°‘ 50%
- æ„å»ºæ—¶é—´ç¼©çŸ­
- ç½‘ç»œé€šä¿¡ç¨³å®š

### **âœ… å¯ç»´æŠ¤æ€§å¢å¼º**
- å•ä¸€é…ç½®æ–‡ä»¶
- æ¸…æ™°çš„æœåŠ¡åˆ†å±‚
- å®Œå–„çš„å¥åº·æ£€æŸ¥
- è¯¦ç»†çš„æ–‡æ¡£

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

```bash
# 1. æ¸…ç†æ—§æœåŠ¡
docker-compose down

# 2. æ¸…ç†èµ„æº
docker system prune -f

# 3. å¯åŠ¨æœåŠ¡
./start-unified.sh

# 4. é€‰æ‹©å¯åŠ¨æ¨¡å¼ï¼ˆæ¨èé€‰ 2ï¼‰
# é€‰æ‹©: 2) åˆ†é˜¶æ®µå¯åŠ¨

# 5. ç­‰å¾…æœåŠ¡å°±ç»ªï¼ˆçº¦ 5-8 åˆ†é’Ÿï¼‰

# 6. è®¿é—®æœåŠ¡
# å‰ç«¯: http://localhost:3000
# åç«¯: http://localhost:3001
# Grafana: http://localhost:3002
```

---

## ğŸ“ **éœ€è¦å¸®åŠ©ï¼Ÿ**

**æŸ¥çœ‹æ—¥å¿—**:
```bash
docker-compose logs -f [service_name]
```

**é‡å¯æœåŠ¡**:
```bash
docker-compose restart [service_name]
```

**å®Œå…¨é‡ç½®**:
```bash
docker-compose down -v
docker system prune -a
./start-unified.sh
```

**ğŸŠ æ­å–œï¼æ‚¨ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªç»Ÿä¸€ã€ä¼˜åŒ–ã€ç¨³å®šçš„ Docker Compose é…ç½®ï¼**
